# SM4 加密算法软件实现与优化实验报告

## 一、实验目的

- 理解国家商用密码 SM4 算法的基本结构和加密流程。
- 掌握使用 Python 实现 SM4 算法的基本方法。
- 实现对单个 128 位明文块的加密功能，支持 ECB 模式。
- 探索并优化软件实现的可读性与结构，为后续性能优化（如向量化、C/C++加速）打下基础。

## 二、算法简介

**SM4** 是国家密码管理局于 2006 年发布的对称分组加密算法，主要参数如下：

| 参数   | 值            |
| ---- | ------------ |
| 分组长度 | 128 位        |
| 密钥长度 | 128 位        |
| 加密轮数 | 32           |
| 模式   | 支持 ECB、CBC 等 |

核心包含：

- 非线性变换（S-box 替换）
- 线性变换（用于密钥扩展与加密轮）
- 密钥扩展（生成 32 轮密钥）
- 加密过程（32 轮 Feistel-like 加密结构）

## 三、实验环境

- 编程语言：Python 3.11
- 操作系统：Windows / Linux / macOS 通用
- 第三方依赖：无（原生 Python 实现）

## 四、程序结构

### 1. 常量定义

- `Sbox`: 256 项的 S 盒，用于非线性替换。
- `FK`: 固定密钥扩展常量。
- `CK`: 密钥轮常量（32 个）。

### 2. 核心函数

| 函数                                 | 说明                |
| ---------------------------------- | ----------------- |
| `rotl(x, n)`                       | 32 位整数循环左移        |
| `tau(B)`                           | 非线性变换（S 盒替代）      |
| `l1(B)`                            | 加密轮线性变换           |
| `l2(B)`                            | 密钥扩展线性变换          |
| `key_expansion(MK)`                | 密钥扩展（主密钥转 32 轮密钥） |
| `sm4_encrypt_block(plaintext, rk)` | 加密一个 128-bit 块    |
| `sm4_encrypt_ecb(data, key)`       | 实现 ECB 模式加密       |

### 3. 编码示例

```python
key = b'0123456789abcdeffedcba9876543210'[:16]
data = b'1234567890abcdef'
cipher = sm4_encrypt_ecb(data, key)
print("Ciphertext:", cipher.hex())
```
