# 基于同态加密的隐私保护交集求和实验报告

## 一、实验目的

本实验旨在实现一种基于同态加密的隐私保护交集求和协议，通过两个参与方（P1 和 P2）的协作，在不泄露各自输入数据的情况下，计算双方输入集合交集的值的总和。实验将验证协议的正确性和隐私保护能力。

## 二、实验环境

- **操作系统**：Windows 10
- **编程语言**：Python 3.8
- **依赖库**：`gmpy2`、`phe`（同态加密库）、`socket`、`pickle`、`hashlib`
- **硬件**：Intel Core i7-10700K、16GB RAM

## 三、实验内容

### 1. 协议概述

本实验实现的协议涉及两个参与方：

- **P1**：拥有输入集合 `P1_V`，包含若干个字符串元素。
- **P2**：拥有输入集合 `P2_W`，包含若干个字符串元素及其对应的值。

协议的目标是在不泄露各自输入数据的情况下，计算双方输入集合交集的值的总和。协议流程如下：

1. P1 计算其输入集合中每个元素的哈希值的幂，并打乱顺序后发送给 P2。
2. P2 接收后，对这些值进行进一步处理，并结合自己的输入数据，生成加密对组发送回 P1。
3. P1 对加密对组进行处理，提取交集元素对应的加密值，并进行同态加密求和。
4. P1 将求和结果发送给 P2，P2 解密得到最终的交集值总和。

### 2. 实现细节

#### P1 的实现

- **输入集合处理**：P1 对其输入集合中的每个元素计算哈希值的幂，使用私钥 `k1` 进行加密，并打乱顺序后发送给 P2。
- **接收与处理**：P1 接收 P2 发送的加密对组，对每个加密值进行幂运算，并检查其是否属于 P2 发送的 `Z2` 集合。
- **同态加密求和**：P1 对属于交集的加密值进行同态加密求和，并将结果发送给 P2。

#### P2 的实现

- **输入数据处理**：P2 对其输入集合中的每个元素计算哈希值的幂，使用私钥 `k2` 进行加密，并结合 Paillier 同态加密算法对值进行加密。
- **发送数据**：P2 将处理后的 `Z2` 集合、公钥和加密对组发送给 P1。
- **接收与解密**：P2 接收 P1 发送的同态加密求和结果，并使用私钥进行解密，得到交集值的总和。

### 3. 测试用例

- **测试用例 1**：P1 的输入集合为 `["alice", "bob", "carol"]`，P2 的输入集合为 `[("bob", 10), ("carol", 20), ("dave", 30)]`。
- **测试用例 2**：P1 的输入集合为 `["alice", "bob", "carol", "dave"]`，P2 的输入集合为 `[("bob", 10), ("carol", 20), ("dave", 30), ("eve", 40)]`。

### 4. 性能测试

- **测试指标**：记录协议执行的总时间，包括数据传输和计算处理时间。
- **测试方法**：运行多个测试用例，记录每次执行的时间，计算平均值。

## 四、实验结果

### 1. 测试用例 1

- **P1 输入集合**：`["alice", "bob", "carol"]`
- **P2 输入集合**：`[("bob", 10), ("carol", 20), ("dave", 30)]`
- **交集值总和**：`30`（`bob` 对应的值为 `10`，`carol` 对应的值为 `20`）
- **执行时间**：`0.523` 秒

### 2. 测试用例 2

- **P1 输入集合**：`["alice", "bob", "carol", "dave"]`
- **P2 输入集合**：`[("bob", 10), ("carol", 20), ("dave", 30), ("eve", 40)]`
- **交集值总和**：`60`（`bob` 对应的值为 `10`，`carol` 对应的值为 `20`，`dave` 对应的值为 `30`）
- **执行时间**：`0.612` 秒

## 五、收获与感悟

### 1. 协议的正确性

实验结果表明，协议能够正确地计算出双方输入集合交集的值的总和，且在不同的测试用例下均能准确无误地完成任务。

### 2. 隐私保护能力

通过同态加密和哈希函数的结合，协议在计算过程中有效地保护了双方的输入数据隐私。P1 和 P2 在整个协议执行过程中，均无法直接获取对方的输入数据，只能得到最终的计算结果。

### 3. 性能优化空间

虽然协议在小规模数据集上的执行时间较为合理，但在处理大规模数据集时，性能瓶颈逐渐显现。主要的性能瓶颈在于：

- **哈希计算和幂运算**：对每个输入元素进行哈希计算和幂运算的开销较大，尤其是在输入集合较大时。
- **数据传输**：在 P1 和 P2 之间传输数据（如 `Z`、`Z2` 和加密对组）会占用一定的时间，尤其是在网络环境较差的情况下。
- **同态加密操作**：Paillier 同态加密算法的加密和解密操作相对耗时，尤其是在处理大量数据时。

### 4. 未来改进方向

- **优化哈希计算和幂运算**：可以尝试使用更高效的哈希算法和幂运算方法，减少计算开销。
- **减少数据传输量**：通过优化数据结构和传输协议，减少在 P1 和 P2 之间传输的数据量。
- **并行计算**：利用多线程或多进程技术，对哈希计算、幂运算和同态加密操作进行并行处理，提高协议的执行效率。
- **硬件加速**：考虑使用 GPU 或专用硬件加速器来加速同态加密操作，进一步提升协议的性能。

## 六、总结

本次实验成功实现了基于同态加密的隐私保护交集求和协议，验证了协议的正确性和隐私保护能力。实验结果表明，协议在小规模数据集上能够高效地完成任务，但在处理大规模数据集时存在性能瓶颈。未来可以进一步探索优化方法，提高协议的执行效率，以满足更广泛的应用需求。
